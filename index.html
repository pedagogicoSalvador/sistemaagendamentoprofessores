<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Agendamento - Professores</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbymljQZ69NpxgNx8Rr9FqomXwhMQGtgolGAZ9IMc4Si7MH8qzsmtwp1wnMlQCEs-Yl1/exec';

    function TeacherSchedulingSystem() {
      const subjects = {
        "L√≠ngua Portuguesa e Reda√ß√£o": {
          icon: "üìö",
          teachers: [
            { id: 1, name: "Prof¬™. Juliana Tricot", turmas: ["8¬∫ e 9¬∫ anos"] },
            { id: 2, name: "Prof¬™. Juliana Velho", turmas: ["Ensino M√©dio"] }
          ]
        },
        "Matem√°tica": {
          icon: "üßÆ",
          teachers: [
            { id: 5, name: "Prof¬™. Aline", turmas: ["7¬∫ anos"] },
            { id: 6, name: "Prof¬™ Eliana", turmas: ["5¬∫ ano - Manh√£"] }
          ]
        }
      };

      const [currentScreen, setCurrentScreen] = useState("home");
      const [selectedSubject, setSelectedSubject] = useState("");
      const [selectedTeacher, setSelectedTeacher] = useState(null);
      const [teacherBookings, setTeacherBookings] = useState(new Map());
      const [parentName, setParentName] = useState("");
      const [studentName, setStudentName] = useState("");
      const [email, setEmail] = useState("");
      const [selectedSlot, setSelectedSlot] = useState("");
      const [message, setMessage] = useState("");
      const [messageType, setMessageType] = useState("");
      const [isLoading, setIsLoading] = useState(false);

      const generateTimeSlots = () => {
        const slots = [];
        let startTime = new Date(); startTime.setHours(18,30,0,0);
        const endTime = new Date(); endTime.setHours(19,50,0,0);
        while(startTime<=endTime){
          slots.push(startTime.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit',hour12:false}));
          startTime.setMinutes(startTime.getMinutes()+10);
        }
        return slots;
      };
      const timeSlots = generateTimeSlots();

      const showMessage = (text,type)=>{
        setMessage(text); setMessageType(type);
        setTimeout(()=>{ setMessage(""); setMessageType(""); },4000);
      };

      const loadBookingsFromAppsScript = async ()=>{
        try{
          setIsLoading(true);
          showMessage("Carregando agendamentos...","success");
          const res = await fetch(APPS_SCRIPT_URL);
          const data = await res.json();
          if(!data.success) throw new Error(data.error||"Erro ao carregar");

          const rows = data.data.slice(1);
          const newBookings = new Map();
          rows.forEach(row=>{
            if(row.length>=6){
              const [teacherName, subject, parent, student, email, time, date] = row;
              let teacherId=null;
              Object.values(subjects).some(subj=>{
                const t = subj.teachers.find(t=>t.name===teacherName);
                if(t){ teacherId=t.id; return true;} return false;
              });
              if(teacherId){
                if(!newBookings.has(teacherId)) newBookings.set(teacherId,new Map());
                newBookings.get(teacherId).set(time,{parentName:parent,studentName:student,email,time,teacher:teacherName,subject,date});
              }
            }
          });
          setTeacherBookings(newBookings);
          showMessage("Agendamentos carregados!","success");
        }catch(err){
          console.error(err);
          showMessage("Erro ao conectar com planilha","error");
        }finally{ setIsLoading(false); }
      };

      const saveBookingToAppsScript = async (booking)=>{
        try{
          setIsLoading(true);
          const res = await fetch(APPS_SCRIPT_URL,{
            method:"POST",
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify(booking)
          });
          const data = await res.json();
          if(!data.success) throw new Error(data.error||"Erro ao salvar");
          return true;
        }catch(err){
          console.error(err);
          showMessage("Erro ao salvar na planilha","error");
          return false;
        }finally{ setIsLoading(false); }
      };

      useEffect(()=>{ loadBookingsFromAppsScript(); },[]);

      const getTeacherBookings = (id)=>teacherBookings.get(id)||new Map();
      const isSlotAvailable = (slot,id)=>!getTeacherBookings(id).has(slot);

      const handleBooking = async ()=>{
        if(!parentName || !studentName || !email || !selectedSlot){ showMessage("Preencha todos os campos e escolha hor√°rio","error"); return; }
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if(!emailRegex.test(email)){ showMessage("Email inv√°lido","error"); return; }

        const current=getTeacherBookings(selectedTeacher.id);
        if(Array.from(current.values()).some(b=>b.email===email)){ showMessage("Este email j√° possui agendamento","error"); return; }
        if(!isSlotAvailable(selectedSlot,selectedTeacher.id)){ showMessage("Hor√°rio indispon√≠vel","error"); return; }

        const booking = { parentName, studentName, email, time:selectedSlot, teacher:selectedTeacher.name, subject:selectedSubject, bookingDate:new Date().toLocaleDateString('pt-BR') };
        const updated = new Map([...current,[selectedSlot,booking]]);
        setTeacherBookings(prev=>new Map([...prev,[selectedTeacher.id,updated]]));

        const saved = await saveBookingToAppsScript(booking);
        showMessage(saved?"Agendamento salvo na planilha!":"Agendamento salvo localmente!", "success");

        setParentName(""); setStudentName(""); setEmail(""); setSelectedSlot("");
      };

      if(isLoading) return <div className="min-h-screen flex items-center justify-center">‚è≥ Sincronizando...</div>;

      if(currentScreen==="home") return (
        <div className="p-6">
          <h1 className="text-3xl font-bold mb-6 text-center">Sistema de Agendamento</h1>
          <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
            {Object.entries(subjects).map(([subject,data])=>(
              <div key={subject} className="p-4 bg-gray-100 rounded-lg cursor-pointer hover:bg-gray-200" onClick={()=>{setSelectedSubject(subject); setCurrentScreen("teachers");}}>
                <div className="text-center text-2xl">{data.icon}</div>
                <h3 className="text-center font-semibold">{subject}</h3>
              </div>
            ))}
          </div>
          {message && <p className={`mt-4 text-center ${messageType==="success"?"text-green-600":"text-red-600"}`}>{message}</p>}
        </div>
      );

      if(currentScreen==="teachers") return (
        <div className="p-6">
          <button onClick={()=>setCurrentScreen("home")} className="mb-4">‚¨ÖÔ∏è Voltar</button>
          <h2 className="text-2xl font-bold mb-4">{selectedSubject} - Professores</h2>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            {subjects[selectedSubject].teachers.map(t=>(
              <div key={t.id} className="p-4 bg-white rounded-lg shadow cursor-pointer hover:shadow-md" onClick={()=>{setSelectedTeacher(t); setCurrentScreen("booking");}}>
                <h3 className="font-semibold">{t.name}</h3>
                <p className="text-sm text-gray-600">{t.turmas.join(", ")}</p>
              </div>
            ))}
          </div>
        </div>
      );

      if(currentScreen==="booking") return (
        <div className="p-6 max-w-md mx-auto bg-white rounded-xl shadow-xl">
          <button onClick={()=>setCurrentScreen("teachers")} className="mb-4">‚¨ÖÔ∏è Voltar</button>
          <h2 className="text-xl font-bold mb-2">Agendamento com {selectedTeacher.name}</h2>
          <p className="mb-4 text-gray-600">Disciplina: {selectedSubject}</p>

          <input type="text" placeholder="Nome do respons√°vel" value={parentName} onChange={e=>setParentName(e.target.value)} className="w-full mb-2 p-2 border rounded"/>
          <input type="text" placeholder="Nome do estudante" value={studentName} onChange={e=>setStudentName(e.target.value)} className="w-full mb-2 p-2 border rounded"/>
          <input type="email" placeholder="Email" value={email} onChange={e=>setEmail(e.target.value)} className="w-full mb-4 p-2 border rounded"/>

          <div className="grid grid-cols-3 gap-2 mb-4">
            {timeSlots.map(slot=>{
              const available=isSlotAvailable(slot,selectedTeacher.id);
              return (
                <button key={slot} disabled={!available} onClick={()=>setSelectedSlot(slot)} className={`p-2 rounded ${selectedSlot===slot?"bg-indigo-600 text-white":available?"bg-green-200":"bg-gray-200 text-gray-400 cursor-not-allowed"}`}>
                  {slot}
                </button>
              )
            })}
          </div>

          <button onClick={handleBooking} className="w-full p-3 bg-indigo-600 text-white rounded mb-2">Confirmar Agendamento</button>
          {message && <p className={`mt-2 text-center ${messageType==="success"?"text-green-600":"text-red-600"}`}>{message}</p>}
        </div>
      );

      return null;
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<TeacherSchedulingSystem />);
  </script>
</body>
</html>

